# データベース閲覧・操作サービス 仕様書

## 1. プロジェクト概要

### 1.1 サービス名
**Universal Database Manager (UDB Manager)**

### 1.2 目的
様々なデータベースに接続し、SQLの知識が少ないユーザーでもデータの取得・編集・閲覧を直感的に行えるWebアプリケーションを提供する。

### 1.3 対象ユーザー
- SQLを書けないビジネスユーザー
- データアナリスト
- データを活用したい非技術者
- 開発者（複数DBの管理用途）

---

## 2. 機能要件

### 2.1 データベース接続管理

#### 2.1.1 対応データベース
- **リレーショナルデータベース**
  - MySQL
  - PostgreSQL
  - SQLite
  - Oracle Database
  - Microsoft SQL Server
- **NoSQLデータベース**
  - MongoDB
- **クラウドデータベース/DWH**
  - Snowflake
  - Salesforce (SOQL対応)

#### 2.1.2 接続設定機能
- 接続情報の登録
  - 接続名（任意の名前）
  - データベースタイプ（ドロップダウン選択）
  - ホスト名/IPアドレス
  - ポート番号
  - データベース名/スキーマ名
  - ユーザー名
  - パスワード
  - 接続オプション（SSL、タイムアウト設定など）
- 接続情報の保存・編集・削除
- 接続テスト機能（接続可否の確認）
- 複数の接続先を管理可能

### 2.2 データベース構造の閲覧

#### 2.2.1 テーブル一覧表示
- 接続中のデータベース内の全テーブル/コレクション一覧を表示
- スキーマごとの階層表示（RDB）
- 検索・フィルタリング機能

#### 2.2.2 テーブル詳細情報
- 指定したテーブルのカラム情報表示
  - カラム名
  - データ型
  - NULL許可/不許可
  - 主キー/外部キー
  - デフォルト値
  - その他制約情報
- インデックス情報
- レコード件数

### 2.3 データ操作機能

#### 2.3.1 データ閲覧（READ）
- テーブルデータのグリッド表示
- ページネーション機能
- ソート機能（カラムクリックで昇順/降順）
- フィルタリング機能
  - カラムごとの検索
  - 条件指定（=, !=, >, <, LIKE, IN など）
- データのエクスポート
  - CSV形式
  - JSON形式
  - Excel形式（オプション）

#### 2.3.2 データ追加（CREATE）
- GUIフォームによるレコード追加
- カラム情報に基づく入力バリデーション
- バッチ挿入（複数レコード一括追加）

#### 2.3.3 データ編集（UPDATE）
- グリッド上での直接編集
- フォームベースの編集
- 複数レコード一括更新

#### 2.3.4 データ削除（DELETE）
- 選択したレコードの削除
- 確認ダイアログ表示
- 複数レコード一括削除

#### 2.3.5 トランザクション管理
- 変更のコミット/ロールバック機能
- 自動コミット/手動コミットの切り替え

### 2.4 SQL実行機能

#### 2.4.1 SQLエディタ
- 自由にSQL文を記述・実行
- シンタックスハイライト
- SQL履歴の保存・呼び出し
- よく使うクエリの保存（ブックマーク機能）

#### 2.4.2 クエリ実行
- SELECT文の実行と結果表示
- INSERT/UPDATE/DELETE文の実行
- DDL文の実行（CREATE, ALTER, DROP など）
- 実行時間の表示
- 影響を受けた行数の表示

#### 2.4.3 クエリビルダー（SQLを書けないユーザー向け）
- GUIベースでクエリを構築
- テーブル選択
- カラム選択
- WHERE条件の設定
- JOIN操作のビジュアル設定
- GROUP BY / ORDER BY の設定
- 生成されたSQLの表示・編集可能

### 2.5 その他機能

#### 2.5.1 データベース固有機能対応
- MongoDB: ドキュメント構造の表示、JSONベースの編集
- Salesforce: SOQLクエリ実行、オブジェクト一覧表示

#### 2.5.2 エラーハンドリング
- データベース接続エラーの表示
- SQL構文エラーの表示
- 制約違反エラーの表示

---

## 3. 非機能要件

### 3.1 セキュリティ
- ユーザー認証: **不要**（要件による）
- 接続情報の暗号化保存
- SQL Injectionの防止（パラメータ化クエリの使用）
- パスワードのマスク表示

### 3.2 パフォーマンス
- 大量データ表示時のページング処理
- クエリ実行タイムアウト設定（デフォルト30秒）
- 非同期処理による画面フリーズの防止

### 3.3 ユーザビリティ
- レスポンシブデザイン（PC、タブレット対応）
- 直感的なUI/UX
- 操作ガイド・ヘルプ機能

### 3.4 可用性
- エラー発生時の適切なメッセージ表示
- セッション管理（接続の自動再接続）

---

## 4. システムアーキテクチャ

### 4.1 技術スタック

#### 4.1.1 バックエンド
- **言語**: Java 17以上
- **フレームワーク**: Spring Boot 3.x
- **ビルドツール**: Maven または Gradle
- **データベース接続**:
  - JDBC（リレーショナルDB用）
  - MongoDB Java Driver
  - Snowflake JDBC Driver
  - Salesforce API (Force.com)

#### 4.1.2 フロントエンド
- **フレームワーク**: React または Vue.js
- **UIライブラリ**: Material-UI または Ant Design
- **データグリッド**: AG-Grid または React Table
- **SQLエディタ**: CodeMirror または Monaco Editor

#### 4.1.3 通信
- REST API（JSON形式）
- WebSocket（リアルタイム更新用、オプション）

### 4.2 システム構成

```
┌─────────────────────────────────────┐
│       フロントエンド (React/Vue)      │
│  - データグリッド                      │
│  - SQLエディタ                        │
│  - 接続管理UI                         │
└─────────────────┬───────────────────┘
                  │ REST API
┌─────────────────▼───────────────────┐
│    バックエンド (Spring Boot)        │
│  - REST APIエンドポイント             │
│  - データベース接続管理                │
│  - クエリ実行エンジン                  │
│  - データ変換・バリデーション           │
└─────────────────┬───────────────────┘
                  │ JDBC/Driver
┌─────────────────▼───────────────────┐
│        各種データベース                │
│  MySQL, PostgreSQL, MongoDB, etc.   │
└─────────────────────────────────────┘
```

### 4.3 主要コンポーネント

#### 4.3.1 データベース接続マネージャー
- 複数DB接続のプーリング管理
- 接続情報の暗号化・復号化
- データベースタイプごとのドライバー管理

#### 4.3.2 メタデータサービス
- テーブル一覧取得
- カラム情報取得
- スキーマ情報取得

#### 4.3.3 クエリ実行エンジン
- SQL文のパース・検証
- クエリ実行
- 結果セットの取得・変換

#### 4.3.4 CRUD操作サービス
- データの取得（SELECT）
- データの挿入（INSERT）
- データの更新（UPDATE）
- データの削除（DELETE）

#### 4.3.5 クエリビルダーサービス
- GUI操作からSQLへの変換
- データベース固有SQL方言への対応

---

## 5. データモデル

### 5.1 接続情報管理

```json
{
  "connectionId": "uuid",
  "connectionName": "My PostgreSQL DB",
  "databaseType": "POSTGRESQL",
  "host": "localhost",
  "port": 5432,
  "databaseName": "mydb",
  "username": "user",
  "password": "encrypted_password",
  "options": {
    "ssl": true,
    "timeout": 30
  },
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

### 5.2 クエリ履歴

```json
{
  "queryId": "uuid",
  "connectionId": "uuid",
  "queryText": "SELECT * FROM users",
  "executionTime": 123,
  "rowsAffected": 100,
  "status": "SUCCESS",
  "executedAt": "2025-01-01T00:00:00Z"
}
```

---

## 6. API設計

### 6.1 接続管理API

```
POST   /api/connections              # 接続情報の登録
GET    /api/connections              # 接続一覧取得
GET    /api/connections/{id}         # 接続情報取得
PUT    /api/connections/{id}         # 接続情報更新
DELETE /api/connections/{id}         # 接続削除
POST   /api/connections/{id}/test    # 接続テスト
```

### 6.2 メタデータAPI

```
GET    /api/connections/{id}/schemas          # スキーマ一覧取得
GET    /api/connections/{id}/tables           # テーブル一覧取得
GET    /api/connections/{id}/tables/{table}   # テーブル詳細情報取得
```

### 6.3 データ操作API

```
GET    /api/connections/{id}/data/{table}     # データ取得
POST   /api/connections/{id}/data/{table}     # データ挿入
PUT    /api/connections/{id}/data/{table}     # データ更新
DELETE /api/connections/{id}/data/{table}     # データ削除
```

### 6.4 クエリ実行API

```
POST   /api/connections/{id}/query            # SQLクエリ実行
GET    /api/connections/{id}/query/history    # クエリ履歴取得
POST   /api/connections/{id}/query/build      # クエリビルダー
```

### 6.5 エクスポートAPI

```
POST   /api/connections/{id}/export           # データエクスポート
```

---

## 7. 画面設計

### 7.1 主要画面

#### 7.1.1 接続管理画面
- 接続一覧表示
- 接続追加/編集/削除
- 接続テスト

#### 7.1.2 データベース構造表示画面
- 左サイドバー: スキーマ・テーブル一覧（ツリー表示）
- メインエリア: テーブル詳細情報・カラム情報

#### 7.1.3 データ閲覧・編集画面
- データグリッド表示
- ツールバー: 追加/編集/削除/エクスポート/更新
- フィルタリング・検索UI
- ページネーション

#### 7.1.4 SQLエディタ画面
- SQLエディタエリア（シンタックスハイライト）
- 実行ボタン
- 実行結果表示エリア
- クエリ履歴サイドバー

#### 7.1.5 クエリビルダー画面
- テーブル選択
- カラム選択
- 条件設定（WHERE句）
- ソート設定
- 生成されたSQL表示
- プレビュー実行

---

## 8. セキュリティ考慮事項

### 8.1 データ保護
- 接続情報のパスワードを暗号化して保存
- AES-256暗号化の使用
- 環境変数での暗号化キー管理

### 8.2 SQL Injection対策
- PreparedStatementの使用
- 入力値のサニタイゼーション
- クエリの検証

### 8.3 接続情報の管理
- パスワードのマスク表示
- セッションタイムアウトの設定
- 接続情報のローカル保存（ブラウザストレージ使用時の暗号化）

---

## 9. 開発計画

### 9.1 Phase 1: MVP（最小実行可能製品）
- MySQL、PostgreSQLへの接続
- テーブル一覧・カラム情報取得
- データ閲覧機能（READ）
- 基本的なSQL実行機能

### 9.2 Phase 2: 機能拡張
- CRUD操作の完全実装
- クエリビルダー機能
- SQLite、SQL Server、Oracle対応
- データエクスポート機能

### 9.3 Phase 3: 高度な機能
- MongoDB対応
- Snowflake、Salesforce対応
- クエリ履歴・ブックマーク機能
- パフォーマンス最適化

---

## 10. 技術的課題と解決策

### 10.1 複数データベース対応
**課題**: データベースごとに異なるSQL方言、メタデータ取得方法  
**解決策**: 
- アダプターパターンの採用
- データベースタイプごとのインターフェース実装
- JDBCメタデータAPIの活用

### 10.2 大量データの表示
**課題**: 数百万件のデータを効率的に表示  
**解決策**:
- サーバーサイドページネーション
- 仮想スクロール（Virtual Scrolling）
- レイジーローディング

### 10.3 NoSQL対応
**課題**: MongoDBなどスキーマレスDBの扱い  
**解決策**:
- ドキュメント構造の動的解析
- JSONエディタの提供
- サンプルドキュメントからのスキーマ推定

### 10.4 セキュリティ
**課題**: 認証なしでの安全性確保  
**解決策**:
- ローカル環境での実行を推奨
- HTTPSの必須化（本番環境）
- 接続情報の暗号化

---

## 11. 運用・保守

### 11.1 ログ管理
- アクセスログ
- エラーログ
- クエリ実行ログ

### 11.2 監視
- データベース接続状態の監視
- エラー率の監視
- レスポンスタイムの監視

### 11.3 バックアップ
- 接続情報のバックアップ
- クエリ履歴のバックアップ

---

## 12. 制約事項

### 12.1 機能制約
- ユーザー認証機能なし（要件による）
- ストアドプロシージャの実行は制限される場合あり
- トリガー、ビューの編集機能は限定的

### 12.2 技術制約
- JavaのJDBC対応データベースに限定
- NoSQLは一部機能制限あり
- クラウドDBはネットワーク遅延の影響を受ける

### 12.3 セキュリティ制約
- 認証なしのため、内部ネットワークまたはローカル環境での使用を推奨
- 本番データベースへの直接接続は非推奨

---

## 13. 将来的な拡張案

- ユーザー認証・認可機能の追加
- チーム共有機能
- クエリのスケジュール実行
- データ可視化（グラフ、チャート）
- ER図の自動生成
- データベースマイグレーション機能
- レプリケーション監視
- パフォーマンスチューニング支援

---

## 14. 参考資料

### 14.1 使用ライブラリ・ドライバー
- MySQL Connector/J
- PostgreSQL JDBC Driver
- MongoDB Java Driver
- Oracle JDBC Driver
- Microsoft JDBC Driver for SQL Server
- Snowflake JDBC Driver
- Force.com API

### 14.2 開発ツール
- IntelliJ IDEA / Eclipse
- Postman (API テスト)
- Docker (開発環境)
- Git (バージョン管理)

---

## 15. まとめ

本仕様書に基づき、Universal Database Managerを開発することで、技術者・非技術者を問わず、様々なデータベースに対して直感的にアクセス・操作できる環境を提供します。段階的な開発により、MVPから段階的に機能を拡張し、最終的には包括的なデータベース管理ツールとして完成させます。

---

**作成日**: 2025年11月21日  
**バージョン**: 1.0  
**作成者**: SWE Agent
