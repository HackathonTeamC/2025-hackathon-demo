name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: ap-northeast-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: |
          cd infrastructure
          terraform init
      
      - name: Terraform Plan
        run: |
          cd infrastructure
          terraform plan -out=tfplan
      
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: |
          cd infrastructure
          terraform apply -auto-approve tfplan

  deploy-lambdas:
    name: Deploy Lambda Functions
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    strategy:
      matrix:
        lambda:
          - scheduled_poster
          - reaction_handler
          - schedule_creator
          - conversation_analyzer
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Build Lambda package
        run: |
          chmod +x scripts/build_lambda.sh
          ./scripts/build_lambda.sh ${{ matrix.lambda }}
      
      - name: Deploy Lambda function
        run: |
          aws lambda update-function-code \
            --function-name slack-bot-calendar-${{ matrix.lambda }} \
            --zip-file fileb://dist/lambda-${{ matrix.lambda }}.zip
      
      - name: Wait for function update
        run: |
          aws lambda wait function-updated \
            --function-name slack-bot-calendar-${{ matrix.lambda }}
      
      - name: Update environment variables
        run: |
          aws lambda update-function-configuration \
            --function-name slack-bot-calendar-${{ matrix.lambda }} \
            --environment "Variables={
              SLACK_SECRET_NAME=slack-bot/credentials,
              GOOGLE_SECRET_NAME=google-calendar/credentials,
              TOPICS_TABLE=SlackBotTopics,
              CONVERSATIONS_TABLE=SlackBotConversations,
              EVENTS_TABLE=SlackBotEvents,
              QUESTIONS_TABLE=SlackBotQuestions,
              AWS_REGION=${{ env.AWS_REGION }},
              LOG_LEVEL=INFO
            }"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-lambdas
    if: github.event.inputs.environment == 'staging' || github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run integration tests
        run: |
          pytest tests/integration/ -v
        env:
          SLACK_TEST_CHANNEL: ${{ secrets.SLACK_TEST_CHANNEL }}
          AWS_REGION: ${{ env.AWS_REGION }}

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-lambdas]
    if: always()
    steps:
      - name: Notify Slack
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "✅ Deployment successful to ${{ github.event.inputs.environment || 'production' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "✅ *Deployment Successful*\n*Environment:* ${{ github.event.inputs.environment || 'production' }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>"
                  }
                }
              ]
            }
      
      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "❌ Deployment failed to ${{ github.event.inputs.environment || 'production' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "❌ *Deployment Failed*\n*Environment:* ${{ github.event.inputs.environment || 'production' }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Action:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
